"""Reference mapping between internal FinancialMetrics fields and Börsdata KPI inputs.

The mapping intentionally refers to KPI metadata by `nameEn` strings so the
client can resolve concrete `kpiId` values at runtime after downloading
`/v1/instruments/kpis/metadata`. Growth and latest-value shortcuts lean on the
screener calculation endpoints where Börsdata exposes them; everything else can
be satisfied through KPI summary payloads. Derived entries fall back to
financial reports when no direct KPI exists.
"""

from __future__ import annotations

from typing import Literal, TypedDict

SourceType = Literal["kpi", "screener", "derived"]
ReportType = Literal["year", "r12", "quarter"]


class MetricMapping(TypedDict, total=False):
    source: SourceType
    metadata_match: list[str]
    default_report_type: ReportType
    screener_calc_group: str
    screener_calc: str
    screener_calc_group_overrides: dict[str, str]
    notes: str
    dependencies: list[str]
    is_percentage: bool  # True if values from Börsdata need /100 conversion


# Mapping keyed by FinancialMetrics attribute name
FINANCIAL_METRICS_MAPPING: dict[str, MetricMapping] = {
    "market_cap": {
        "source": "derived",
        "metadata_match": ["Market Cap"],
        "default_report_type": "r12",
        "notes": ("Use KPI when available; otherwise multiply latest close price by the " "most recent shares outstanding from reports."),
        "dependencies": ["latest_close_price", "shares_outstanding"],
    },
    "enterprise_value": {
        "source": "kpi",
        "metadata_match": ["Enterprise Value"],
        "kpi_id": 49,
        "default_report_type": "r12",
    },
    "price_to_earnings_ratio": {
        "source": "kpi",
        "metadata_match": ["P/E", "Price to Earnings"],
        "kpi_id": 2,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Direct KPI call to Börsdata P/E ratio (KPI ID 2)",
    },
    "price_to_book_ratio": {
        "source": "kpi",
        "metadata_match": ["P/B", "Price to Book"],
        "kpi_id": 4,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Direct KPI call to Börsdata P/B ratio (KPI ID 4)",
    },
    "price_to_sales_ratio": {
        "source": "kpi",
        "metadata_match": ["P/S", "Price to Sales"],
        "kpi_id": 3,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Direct KPI call to Börsdata P/S ratio (KPI ID 3)",
    },
    "enterprise_value_to_ebitda_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/EBITDA"],
        "kpi_id": 11,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "enterprise_value_to_ebit_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/EBIT"],
        "kpi_id": 10,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Direct KPI call to Börsdata EV/EBIT ratio (KPI ID 10)",
    },
    "enterprise_value_to_revenue_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/S"],
        "kpi_id": 15,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "net_debt": {
        "source": "kpi",
        "metadata_match": ["Net Debt"],
        "default_report_type": "r12",
    },
    "operating_income": {
        "source": "kpi",
        "metadata_match": ["Operating Income", "EBIT"],
        "default_report_type": "r12",
    },
    "free_cash_flow_yield": {
        "source": "derived",
        "metadata_match": ["FCF Yield"],
        "default_report_type": "r12",
        "notes": "Calculated as 1/P_FCF ratio since Börsdata has P/FCF (KPI 16) but not FCF Yield directly",
        "dependencies": ["price_to_fcf_ratio"],
        "calculation": "inverse",
        "is_percentage": True,
    },
    "peg_ratio": {
        "source": "screener",
        "metadata_match": ["PEG"],
        "default_report_type": "r12",
        "screener_calc_group": "1year",
        "screener_calc": "latest",
    },
    "gross_margin": {
        "source": "kpi",
        "metadata_match": ["Gross Margin"],
        "kpi_id": 28,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "operating_margin": {
        "source": "kpi",
        "metadata_match": ["Operating Margin"],
        "kpi_id": 29,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "net_margin": {
        "source": "kpi",
        "metadata_match": ["Net Margin", "Profit Margin"],
        "kpi_id": 30,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "return_on_equity": {
        "source": "kpi",
        "metadata_match": ["Return on Equity"],
        "kpi_id": 33,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "return_on_assets": {
        "source": "kpi",
        "metadata_match": ["Return on Assets"],
        "kpi_id": 34,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "return_on_invested_capital": {
        "source": "kpi",
        "metadata_match": ["Return on Invested Capital", "ROIC"],
        "kpi_id": 37,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "asset_turnover": {
        "source": "kpi",
        "metadata_match": ["Assets Turnover"],
        "kpi_id": 38,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "inventory_turnover": {
        "source": "kpi",
        "metadata_match": ["Inventory Turnover"],
        "default_report_type": "r12",
    },
    "receivables_turnover": {
        "source": "kpi",
        "metadata_match": ["Receivables Turnover"],
        "default_report_type": "r12",
    },
    "days_sales_outstanding": {
        "source": "kpi",
        "metadata_match": ["Days Sales Outstanding"],
        "default_report_type": "r12",
    },
    "operating_cycle": {
        "source": "derived",
        "metadata_match": ["Operating Cycle"],
        "default_report_type": "r12",
        "dependencies": ["days_sales_outstanding", "days_inventory_outstanding"],
        "notes": ("If the dedicated KPI is unavailable, add DSO and days inventory outstanding " "derived from report data."),
    },
    "working_capital_turnover": {
        "source": "kpi",
        "metadata_match": ["Working Capital Turnover"],
        "default_report_type": "r12",
    },
    "current_ratio": {
        "source": "kpi",
        "metadata_match": ["Current Ratio"],
        "kpi_id": 44,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "quick_ratio": {
        "source": "kpi",
        "metadata_match": ["Quick Ratio"],
        "default_report_type": "year",
    },
    "cash_ratio": {
        "source": "kpi",
        "metadata_match": ["Cash Ratio"],
        "default_report_type": "year",
    },
    "operating_cash_flow_ratio": {
        "source": "derived",
        "metadata_match": ["Operating Cash Flow Ratio"],
        "default_report_type": "r12",
        "dependencies": ["operating_cash_flow", "current_liabilities"],
        "notes": "Divide operating cash flow (cash-flow report) by current liabilities (balance sheet).",
    },
    "debt_to_equity": {
        "source": "kpi",
        "metadata_match": ["Debt/Equity", "Debt to Equity"],
        "kpi_id": 40,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "debt_to_assets": {
        "source": "derived",
        "metadata_match": ["Debt/Assets"],
        "default_report_type": "year",
        "dependencies": ["total_liabilities", "total_assets"],
    },
    "interest_coverage": {
        "source": "kpi",
        "metadata_match": ["Interest Coverage"],
        "default_report_type": "r12",
    },
    "revenue_growth": {
        "source": "screener",
        "metadata_match": ["Sales Growth %"],
        "kpi_id": 26,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "screener_calc_group_overrides": {"quarter": "1year", "3year": "3year", "5year": "5year", "r12": "1year"},
        "is_percentage": True,
    },
    "earnings_growth": {
        "source": "screener",
        "metadata_match": ["EPS Growth %"],
        "kpi_id": 27,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "screener_calc_group_overrides": {"quarter": "1year", "3year": "3year", "5year": "5year"},
        "is_percentage": True,
    },
    "book_value_growth": {
        "source": "screener",
        "metadata_match": ["Book Value Growth", "Equity Growth"],
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "percent",
        "screener_calc_group_overrides": {"quarter": "quarter"},
        "is_percentage": True,
    },
    "earnings_per_share_growth": {
        "source": "derived",
        "metadata_match": ["EPS Growth"],
        "default_report_type": "year",
        "dependencies": ["earnings_per_share"],
    },
    "free_cash_flow_growth": {
        "source": "screener",
        "metadata_match": ["FCF growth"],
        "kpi_id": 23,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "screener_calc_group_overrides": {"quarter": "1year", "3year": "3year", "5year": "5year"},
        "is_percentage": True,
    },
    "operating_income_growth": {
        "source": "screener",
        "metadata_match": ["EBIT Growth"],
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "percent",
        "screener_calc_group_overrides": {"quarter": "quarter"},
        "is_percentage": True,
    },
    "ebitda_growth": {
        "source": "derived",
        "metadata_match": ["EBITDA Growth"],
        "default_report_type": "year",
        "dependencies": ["ebitda"],
    },
    "payout_ratio": {
        "source": "kpi",
        "metadata_match": ["Dividend Payout"],
        "default_report_type": "year",
    },
    "earnings_per_share": {
        "source": "kpi",
        "metadata_match": ["Earnings/share"],
        "kpi_id": 6,
        "default_report_type": "r12",
        "notes": "Available as KPI ID 6",
    },
    "book_value_per_share": {
        "source": "kpi",
        "metadata_match": ["Book value/share"],
        "default_report_type": "r12",
        "notes": "Available as KPI ID 8",
    },
    "free_cash_flow_per_share": {
        "source": "derived",
        "metadata_match": ["Free Cash Flow per Share", "FCF/Share"],
        "default_report_type": "r12",
    },
    "revenue_per_share": {
        "source": "kpi",
        "metadata_match": ["Revenue/share"],
        "default_report_type": "r12",
        "notes": "Available as KPI ID 5",
    },
    # New value-add metrics from Börsdata
    "ev_to_fcf_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/FCF"],
        "kpi_id": 13,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Enterprise Value to Free Cash Flow ratio - new metric from Börsdata",
    },
    "fcf_margin": {
        "source": "kpi",
        "metadata_match": ["FCF margin"],
        "kpi_id": 31,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Free Cash Flow margin - new metric from Börsdata",
        "is_percentage": True,
    },
    "cash_per_share": {
        "source": "kpi",
        "metadata_match": ["Cash"],
        "kpi_id": 45,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Cash per share - new metric from Börsdata",
    },
    "dividend_yield": {
        "source": "kpi",
        "metadata_match": ["Dividend Yield"],
        "kpi_id": 1,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "notes": "Dividend yield percentage - direct from Börsdata KPI",
        "is_percentage": True,
    },
    
    # Additional critical KPIs from comprehensive Börsdata set
    "ebitda_margin": {
        "source": "kpi",
        "metadata_match": ["EBITDA margin", "EBITDA-marginal"],
        "kpi_id": 32,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "equity_ratio": {
        "source": "kpi",
        "metadata_match": ["Equity ratio", "Soliditet"],
        "kpi_id": 39,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "net_debt": {
        "source": "kpi",
        "metadata_match": ["Net Debt"],
        "kpi_id": 60,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "net_debt_to_ebitda": {
        "source": "kpi",
        "metadata_match": ["Net Debt / EBITDA", "Nettoskuld/EBITDA"],
        "kpi_id": 42,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "ocf_margin": {
        "source": "kpi",
        "metadata_match": ["OCF margin", "OP-marginal"],
        "kpi_id": 51,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "dividend_payout_ratio": {
        "source": "kpi",
        "metadata_match": ["Dividend Payout", "Utdelningsandel"],
        "kpi_id": 20,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "price_to_fcf_ratio": {
        "source": "kpi",
        "metadata_match": ["P/FCF"],
        "kpi_id": 76,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "price_to_ebit_ratio": {
        "source": "kpi",
        "metadata_match": ["P/EBIT"],
        "kpi_id": 75,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "price_to_ebitda_ratio": {
        "source": "kpi",
        "metadata_match": ["P/EBITDA"],
        "kpi_id": 74,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "ev_to_fcf_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/FCF"],
        "kpi_id": 13,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "ev_to_ocf_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/OCF", "EV/OP"],
        "kpi_id": 78,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "ebit_per_share": {
        "source": "kpi",
        "metadata_match": ["EBIT / Share", "EBIT / Aktie"],
        "kpi_id": 70,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "ebitda_per_share": {
        "source": "kpi",
        "metadata_match": ["EBITA/share", "EBITDA/Aktie"],
        "kpi_id": 71,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "operating_cash_flow_per_share": {
        "source": "kpi",
        "metadata_match": ["Operating Cash Flow/share", "Operativ kassaflöde/Aktie"],
        "kpi_id": 68,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "net_debt_per_share": {
        "source": "kpi",
        "metadata_match": ["Net Debt/share", "Nettoskuld/Aktie"],
        "kpi_id": 73,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "return_on_tangible_assets": {
        "source": "kpi",
        "metadata_match": ["Return on tangible assets", "Avkastning på T-G"],
        "kpi_id": 35,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "return_on_capital": {
        "source": "kpi",
        "metadata_match": ["Return on Capital", "ROC"],
        "kpi_id": 36,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "dividend_growth": {
        "source": "kpi",
        "metadata_match": ["Dividend growth", "Utdelningstillväxt"],
        "kpi_id": 98,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "is_percentage": True,
    },
    "assets_growth": {
        "source": "kpi",
        "metadata_match": ["Assets growth", "Tillväxt Totala Tillgångar"],
        "kpi_id": 100,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "is_percentage": True,
    },
    "cash_to_price_ratio": {
        "source": "kpi",
        "metadata_match": ["Cash/Price", "Cash-%"],
        "kpi_id": 25,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "working_capital_percentage": {
        "source": "kpi",
        "metadata_match": ["Workingcapital-%", "Rörelsekapital-%"],
        "kpi_id": 93,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "intangible_assets_percentage": {
        "source": "kpi",
        "metadata_match": ["Intang.assets-%", "Immat.tillgång.-%"],
        "kpi_id": 92,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    
    # Additional critical financial KPIs from Börsdata (expanding toward 322 total)
    # NOTE: debt_to_equity already defined above - removing duplicate
    "debt_to_assets": {
        "source": "kpi",
        "metadata_match": ["Debt to Assets", "Skuld/Tillgångar"],
        "kpi_id": 41,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "interest_coverage": {
        "source": "kpi",
        "metadata_match": ["Interest Coverage", "Räntetäckning"],
        "kpi_id": 43,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    # NOTE: current_ratio already defined above - removing duplicate with incorrect KPI ID 47
    "quick_ratio": {
        "source": "kpi",
        "metadata_match": ["Quick Ratio", "Snabb Likviditet"],
        "kpi_id": 48,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "cash_ratio": {
        "source": "kpi",
        "metadata_match": ["Cash Ratio", "Kassalikviditet"],
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "working_capital_turnover": {
        "source": "kpi",
        "metadata_match": ["Working Capital Turnover", "Rörelsekapitalomsättning"],
        "kpi_id": 46,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "days_sales_outstanding": {
        "source": "kpi",
        "metadata_match": ["Days Sales Outstanding", "Kundfordringars omsättningstid"],
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "capex_percentage": {
        "source": "kpi",
        "metadata_match": ["Capex %", "Investeringar %"],
        "kpi_id": 54,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },

    "free_cash_flow": {
        "source": "derived",
        "metadata_match": ["Free Cash Flow", "Fritt kassaflöde"],
        "default_report_type": "r12",
        "dependencies": ["free_Cash_Flow"],
    },
    "operating_cash_flow": {
        "source": "kpi",
        "metadata_match": ["Operating Cash Flow", "Operativt kassaflöde"],
        "kpi_id": 66,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "cash_flow_stability": {
        "source": "kpi",
        "metadata_match": ["Cash Flow Stability", "Kassaflöde Stabilitet"],
        "kpi_id": 95,
        "default_report_type": "5year",
        "screener_calc_group": "5year",
        "screener_calc": "stability",
    },
    "total_dividend_yield": {
        "source": "kpi",
        "metadata_match": ["Total dividend yield", "Total utdelningsavkastning"],
        "kpi_id": 85,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "yield_on_cost": {
        "source": "kpi",
        "metadata_match": ["YieldOnCost", "Avkastning på kostnad"],
        "kpi_id": 84,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "earnings_fcf_ratio": {
        "source": "kpi",
        "metadata_match": ["Earnings/FCF", "Resultat/FCF"],
        "kpi_id": 56,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "dividend_fcf_ratio": {
        "source": "kpi",
        "metadata_match": ["Dividend/FCF", "Utdelning/FCF"],
        "kpi_id": 55,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "cash_flow_year_marginal": {
        "source": "kpi",
        "metadata_match": ["Cash flow - year marginal", "Kassaflöde årsförändring"],
        "kpi_id": 94,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "percent",
        "is_percentage": True,
    },
    "fcf_growth_1y": {
        "source": "kpi",
        "metadata_match": ["FCF growth", "FCF tillväxt"],
        "kpi_id": 52,
        "default_report_type": "year",
        "screener_calc_group": "1year",
        "screener_calc": "cagr",
        "is_percentage": True,
    },
    "cash_flow_financing": {
        "source": "kpi",
        "metadata_match": ["Cash flow - Financing", "Kassaflöde från finansiering"],
        "kpi_id": 104,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "cash_flow_year_per_share": {
        "source": "kpi",
        "metadata_match": ["Cash flow - year/share", "Kassaflöde år/aktie"],
        "kpi_id": 69,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "total_return": {
        "source": "kpi",
        "metadata_match": ["Total Return", "Totalavkastning"],
        "kpi_id": 83,
        "default_report_type": "1year",
        "screener_calc_group": "1year",
        "screener_calc": "percent",
        "is_percentage": True,
    },
    "beta": {
        "source": "derived",
        "metadata_match": ["Beta"],
        "default_report_type": "3year",
        "dependencies": [],
    },
    "alpha": {
        "source": "kpi",
        "metadata_match": ["Alpha"],
        "kpi_id": 81,
        "default_report_type": "3year",
        "screener_calc_group": "3year",
        "screener_calc": "latest",
    },
    "volatility": {
        "source": "kpi",
        "metadata_match": ["Volatility", "Volatilitet"],
        "kpi_id": 82,
        "default_report_type": "1year",
        "screener_calc_group": "1year",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "ev_revenue_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/S"],
        "kpi_id": 14,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "earnings_ev_percentage": {
        "source": "kpi",
        "metadata_match": ["E/EV (%)"],
        "kpi_id": 16,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "ebit_ev_percentage": {
        "source": "kpi",
        "metadata_match": ["EBIT/EV (%)"],
        "kpi_id": 17,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
        "is_percentage": True,
    },
    "price_book_tangible": {
        "source": "kpi",
        "metadata_match": ["P/B-tang"],
        "kpi_id": 18,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "price_earnings_ex": {
        "source": "kpi",
        "metadata_match": ["P/(E)x"],
        "kpi_id": 9,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "dividend_per_share": {
        "source": "kpi",
        "metadata_match": ["Dividend", "Utdelning"],
        "kpi_id": 7,
        "default_report_type": "year",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "enterprise_value_to_ebitda_ratio": {
        "source": "kpi",
        "metadata_match": ["EV/EBITDA"],
        "kpi_id": 11,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "rsi": {
        "source": "kpi",
        "metadata_match": ["RSI"],
        "kpi_id": 159,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
    "bollinger_bands": {
        "source": "kpi",
        "metadata_match": ["Bollinger band"],
        "kpi_id": 161,
        "default_report_type": "r12",
        "screener_calc_group": "last",
        "screener_calc": "latest",
    },
}


DERIVED_REPORT_DEPENDENCIES = {
    "operating_cash_flow": {
        "statement": "cash_flow",
        "keys": ["NetCashFromOperatingActivities", "OperatingCashFlow"],
    },
    "current_liabilities": {
        "statement": "balance_sheet",
        "keys": ["CurrentLiabilities"],
    },
    "shares_outstanding": {
        "statement": "income_statement",
        "keys": ["AverageSharesOutstanding", "SharesOutstanding"],
    },
    "days_inventory_outstanding": {
        "statement": "calculated",
        "keys": ["DaysInventoryOutstanding"],
    },
    "latest_close_price": {
        "statement": "price",
        "keys": ["c"],
    },
    "revenue_per_share": {
        "statement": "kpi",
        "kpi_id": 5,
        "keys": ["Revenue/share"],
    },
    "price_divided_by_eps": {
        "statement": "calculated",
        "calculation": "divide",
        "numerator": "latest_close_price",
        "denominator": "earnings_per_share",
    },
    "price_divided_by_book_value": {
        "statement": "calculated",
        "calculation": "divide",
        "numerator": "latest_close_price",
        "denominator": "book_value_per_share",
    },
    "price_divided_by_revenue": {
        "statement": "calculated",
        "calculation": "divide",
        "numerator": "latest_close_price",
        "denominator": "revenue_per_share",
    },
}
"""Helper hints for translating Börsdata report payload keys into derived metrics."""
